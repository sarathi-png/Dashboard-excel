<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SHG Analytics Pro | National Rural Livelihoods Mission Dashboard</title>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Premium Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&family=Playfair+Display:wght@600;700;800&display=swap"
        rel="stylesheet" />

    <style>
        /* ============ CSS CUSTOM PROPERTIES ============ */
        :root {
            /* ... existing vars ... */
            --font-display: 'Playfair Display', Georgia, serif;
            /* ... */
        }

        /* ... existing styles ... */

        /* ============ 3D HUB PORTAL STYLES ============ */
        #hub-portal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at center, #1a365d 0%, #030712 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            perspective: 2000px;
            overflow: hidden;
            transition: opacity 0.8s ease, visibility 0.8s ease;
        }

        #hub-portal.hidden-portal {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .hub-background {
            position: absolute;
            width: 200%;
            height: 200%;
            background:
                linear-gradient(rgba(12, 25, 41, 0.8), rgba(12, 25, 41, 0.8)),
                url('https://www.transparenttextures.com/patterns/cubes.png');
            animation: bgRotate 60s linear infinite;
            z-index: -1;
            opacity: 0.3;
        }

        @keyframes bgRotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .hub-title {
            font-family: var(--font-display);
            font-size: clamp(2.5rem, 6vw, 4rem);
            color: white;
            text-align: center;
            margin-bottom: 60px;
            text-shadow: 0 0 30px rgba(212, 168, 83, 0.5);
            animation: floatTitle 4s ease-in-out infinite;
            transform-style: preserve-3d;
            transform: translateZ(50px);
        }

        @keyframes floatTitle {

            0%,
            100% {
                transform: translateZ(50px) translateY(0);
            }

            50% {
                transform: translateZ(50px) translateY(-15px);
            }
        }

        .hub-cards-container {
            display: flex;
            gap: 60px;
            transform-style: preserve-3d;
            padding: 20px;
        }

        .hub-card {
            width: 320px;
            height: 450px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative;
            transform-style: preserve-3d;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .hub-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-20px) rotateX(10deg) scale(1.05);
            box-shadow: 0 40px 80px rgba(212, 168, 83, 0.2);
            border-color: var(--accent-gold);
        }

        .hub-card-icon {
            font-size: 5rem;
            margin-bottom: 30px;
            transform: translateZ(40px);
            filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.5));
        }

        .hub-card-title {
            font-family: var(--font-display);
            font-size: 1.8rem;
            color: white;
            margin-bottom: 10px;
            transform: translateZ(30px);
            text-align: center;
        }

        .hub-card-desc {
            font-family: var(--font-secondary);
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: center;
            padding: 0 20px;
            transform: translateZ(20px);
            line-height: 1.5;
        }

        .hub-card-btn {
            margin-top: 40px;
            padding: 12px 30px;
            background: var(--gradient-accent);
            border: none;
            border-radius: 30px;
            color: var(--primary-900);
            font-weight: 700;
            transform: translateZ(30px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .hub-card:hover .hub-card-btn {
            transform: translateZ(50px) scale(1.1);
            box-shadow: 0 0 30px rgba(212, 168, 83, 0.6);
        }

        /* Full Screen Iframe Container */
        #member-dashboard-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 5000;
            background: var(--bg-primary);
            transition: transform 0.6s ease-in-out;
            transform: translateX(100%);
        }

        #member-dashboard-view.active-view {
            transform: translateX(0);
        }

        #member-frame {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Back Button for Views */
        .back-to-hub-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            /* Changed from right to left to avoid conflict with other controls */
            z-index: 99999;
            /* Super high z-index */
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border: 2px solid var(--accent-gold);
            color: var(--accent-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            opacity: 0;
            pointer-events: none;
        }

        .back-to-hub-btn.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .back-to-hub-btn:hover {
            transform: scale(1.1) rotate(-90deg);
            background: var(--accent-gold);
            color: var(--primary-900);
            box-shadow: 0 0 30px rgba(212, 168, 83, 0.8);
        }

        /* Adjust Main Dashboard Container */
        .dashboard-container {
            transition: transform 0.6s ease-in-out, opacity 0.6s ease;
        }

        .dashboard-hidden {
            transform: scale(0.9) translateZ(-100px);
            opacity: 0;
            pointer-events: none;
            height: 0;
            overflow: hidden;
        }

        /* Responsive Hub */
        @media (max-width: 800px) {
            .hub-cards-container {
                flex-direction: column;
                gap: 30px;
            }

            .hub-card {
                width: 280px;
                height: 350px;
            }

            .hub-title {
                margin-bottom: 30px;
            }
        }

        /* ============ CSS CUSTOM PROPERTIES ============ */
        :root {
            --font-display: 'Playfair Display', Georgia, serif;
            --font-primary: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-secondary: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;

            /* Government Blue Theme */
            --primary-900: #0c1929;
            --primary-800: #0f2744;
            --primary-700: #1a365d;
            --primary-600: #234876;
            --primary-500: #2b5a8f;
            --primary-400: #3d7cb8;
            --primary-300: #5a9bd4;
            --primary-200: #89bce8;
            --primary-100: #c4def5;
            --primary-50: #e8f4fc;

            /* Accent Colors */
            --accent-gold: #d4a853;
            --accent-gold-light: #f4d794;
            --accent-emerald: #059669;
            --accent-emerald-light: #10b981;
            --accent-crimson: #dc2626;
            --accent-amber: #f59e0b;
            --accent-indigo: #4f46e5;
            --accent-purple: #7c3aed;

            /* Dark Theme */
            --bg-primary: #030712;
            --bg-secondary: #0a1628;
            --bg-card: rgba(15, 39, 68, 0.6);
            --bg-card-hover: rgba(26, 54, 93, 0.8);
            --bg-elevated: rgba(35, 72, 118, 0.4);

            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --text-accent: var(--accent-gold);

            --border-primary: rgba(59, 130, 246, 0.2);
            --border-accent: rgba(212, 168, 83, 0.3);
            --border-glow: rgba(59, 130, 246, 0.5);

            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 8px 30px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 40px rgba(59, 130, 246, 0.15);
            --shadow-gold: 0 0 30px rgba(212, 168, 83, 0.2);

            --gradient-primary: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-900) 100%);
            --gradient-accent: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-light) 100%);
            --gradient-success: linear-gradient(135deg, var(--accent-emerald) 0%, var(--accent-emerald-light) 100%);
            --gradient-hero: linear-gradient(180deg, var(--primary-800) 0%, var(--bg-primary) 100%);

            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-2xl: 32px;
        }

        [data-theme="light"] {
            --bg-primary: #f1f5f9;
            --bg-secondary: #ffffff;
            --bg-card: rgba(255, 255, 255, 0.9);
            --bg-card-hover: rgba(255, 255, 255, 1);
            --bg-elevated: rgba(241, 245, 249, 0.9);

            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --text-accent: var(--primary-600);

            --border-primary: rgba(15, 23, 42, 0.1);
            --border-accent: rgba(26, 54, 93, 0.2);
            --border-glow: rgba(59, 130, 246, 0.3);

            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 8px 30px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.15);
            --shadow-glow: 0 0 40px rgba(59, 130, 246, 0.1);

            --gradient-hero: linear-gradient(180deg, var(--primary-100) 0%, var(--bg-primary) 100%);
        }

        /* ============ 3D INTERNAL DASHBOARD STYLES ============ */
        /* Upgrade internal components to match 3D Hub */

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-xl);
            box-shadow:
                0 10px 30px -10px rgba(0, 0, 0, 0.5),
                inset 0 0 0 1px rgba(255, 255, 255, 0.05);
            transform-style: preserve-3d;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .stat-card:hover {
            transform: translateY(-10px) rotateX(5deg);
            box-shadow:
                0 20px 40px -10px rgba(0, 0, 0, 0.6),
                0 0 20px rgba(59, 130, 246, 0.2),
                inset 0 0 0 1px rgba(255, 255, 255, 0.1);
            border-color: var(--accent-gold);
            z-index: 10;
        }

        .stat-icon {
            transform: translateZ(20px);
            filter: drop-shadow(0 10px 10px rgba(0, 0, 0, 0.3));
        }

        .stat-value {
            transform: translateZ(15px);
            text-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            transform: translateZ(10px);
        }

        /* 3D Charts */
        .chart-container {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-xl);
            box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            transform-style: preserve-3d;
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.6);
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* 3D Tabs */
        .nav-tabs {
            background: rgba(0, 0, 0, 0.2);
            padding: 8px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.2);
            display: inline-flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .nav-tab {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 10px 24px;
            border-radius: 30px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .nav-tab.active {
            background: var(--gradient-accent);
            color: var(--primary-900);
            box-shadow: 0 5px 15px rgba(212, 168, 83, 0.4);
            transform: scale(1.05);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        /* 3D Upload Section */
        .upload-section {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px dashed var(--accent-gold);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            transform: perspective(1000px) rotateX(2deg);
            transition: all 0.5s ease;
        }

        .upload-section:hover {
            transform: perspective(1000px) rotateX(0) scale(1.02);
            background: rgba(255, 255, 255, 0.05);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
            border-style: solid;
        }

        /* 3D Tables */
        table {
            border-collapse: separate;
            border-spacing: 0 8px;
        }

        thead th {
            background: transparent !important;
            color: var(--accent-gold) !important;
            font-family: var(--font-display);
            letter-spacing: 1px;
            text-transform: uppercase;
            border: none !important;
        }

        tbody tr {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        tbody tr:hover {
            transform: scale(1.01) translateZ(10px);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            z-index: 5;
            position: relative;
        }

        td {
            border: none !important;
            padding: 16px !important;
        }

        td:first-child {
            border-radius: 10px 0 0 10px;
        }

        td:last-child {
            border-radius: 0 10px 10px 0;
        }

        /* ============ BASE STYLES ============ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-primary);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
            transition: background 0.5s ease, color 0.5s ease;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse 100% 100% at 0% 0%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse 80% 80% at 100% 0%, rgba(212, 168, 83, 0.05) 0%, transparent 50%),
                radial-gradient(ellipse 60% 60% at 100% 100%, rgba(5, 150, 105, 0.05) 0%, transparent 50%),
                radial-gradient(ellipse 80% 80% at 0% 100%, rgba(79, 70, 229, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            animation: bgShift 20s ease-in-out infinite alternate;
        }

        @keyframes bgShift {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0.8;
                transform: scale(1.1);
            }
        }

        /* ============ HEADER & BRANDING ============ */
        .gov-header {
            background: var(--gradient-hero);
            border-bottom: 1px solid var(--border-primary);
            padding: 0;
            position: relative;
            overflow: hidden;
        }

        .gov-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg,
                    var(--accent-gold) 0%,
                    var(--primary-400) 25%,
                    var(--accent-emerald) 50%,
                    var(--primary-400) 75%,
                    var(--accent-gold) 100%);
            background-size: 200% 100%;
            animation: gradientSlide 8s linear infinite;
        }

        @keyframes gradientSlide {
            0% {
                background-position: 0% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .gov-top-bar {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .gov-emblem {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .gov-emblem-icon {
            width: 36px;
            height: 36px;
            background: var(--gradient-accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: var(--shadow-gold);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: var(--shadow-gold);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 40px rgba(212, 168, 83, 0.4);
            }
        }

        .gov-main-header {
            padding: 30px 20px 40px;
            text-align: center;
            position: relative;
        }

        .gov-title-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(212, 168, 83, 0.15);
            border: 1px solid var(--border-accent);
            padding: 6px 16px;
            border-radius: 30px;
            font-family: var(--font-mono);
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--accent-gold);
            margin-bottom: 16px;
            animation: fadeInDown 0.8s ease;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .gov-title {
            font-family: var(--font-display);
            font-weight: 700;
            font-size: clamp(2rem, 5vw, 3.5rem);
            letter-spacing: -0.02em;
            line-height: 1.2;
            margin-bottom: 12px;
            animation: fadeInUp 0.8s ease 0.2s both;
        }

        .gov-title .highlight {
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .gov-subtitle {
            font-family: var(--font-secondary);
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            color: var(--text-secondary);
            font-weight: 400;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            animation: fadeInUp 0.8s ease 0.4s both;
        }

        .gov-subtitle .divider {
            width: 6px;
            height: 6px;
            background: var(--accent-gold);
            border-radius: 50%;
            opacity: 0.6;
        }

        /* ============ THEME TOGGLE ============ */
        .theme-toggle {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 2px solid var(--border-primary);
            backdrop-filter: blur(20px);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            z-index: 1000;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-md);
        }

        .theme-toggle:hover {
            transform: rotate(180deg) scale(1.1);
            border-color: var(--accent-gold);
            box-shadow: var(--shadow-gold);
        }

        /* ============ CONTAINER ============ */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* ============ UPLOAD SECTION ============ */
        .upload-section {
            background: var(--bg-card);
            border: 2px dashed var(--border-primary);
            border-radius: var(--radius-xl);
            padding: 50px 40px;
            text-align: center;
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-md);
            margin-bottom: 30px;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            animation: scaleIn 0.6s ease;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .upload-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            transition: left 0.8s ease;
        }

        .upload-section:hover {
            border-color: var(--accent-gold);
            box-shadow: var(--shadow-gold);
        }

        .upload-section:hover::before {
            left: 100%;
        }

        .upload-icon {
            width: 80px;
            height: 80px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 2rem;
            border: 3px solid var(--border-accent);
            animation: float 4s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .upload-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .upload-desc {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .upload-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: center;
            align-items: center;
        }

        input[type="file"] {
            padding: 14px 20px;
            font-family: var(--font-primary);
            font-size: 0.9rem;
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        input[type="file"]:hover {
            border-color: var(--primary-400);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
        }

        /* ============ BUTTONS ============ */
        .btn-primary {
            position: relative;
            padding: 16px 32px;
            font-family: var(--font-primary);
            font-weight: 600;
            font-size: 1rem;
            background: var(--gradient-accent);
            border: none;
            border-radius: var(--radius-md);
            color: var(--primary-900);
            cursor: pointer;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 30px rgba(212, 168, 83, 0.4);
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(212, 168, 83, 0.5);
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-export {
            padding: 10px 18px;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            font-weight: 500;
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-export:hover {
            background: var(--primary-600);
            color: white;
            border-color: var(--primary-500);
            transform: translateY(-2px);
        }

        /* ============ NAVIGATION TABS ============ */
        .nav-tabs {
            display: none;
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 8px;
            margin-bottom: 30px;
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-md);
            flex-wrap: wrap;
            gap: 4px;
            animation: slideDown 0.5s ease;
        }

        .nav-tabs.visible {
            display: flex;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .nav-tab {
            position: relative;
            padding: 14px 24px;
            font-family: var(--font-primary);
            font-size: 0.85rem;
            font-weight: 500;
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: var(--gradient-accent);
            transition: all 0.3s ease;
            transform: translateX(-50%);
            border-radius: 3px;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: var(--bg-elevated);
        }

        .nav-tab:hover::before {
            width: 60%;
        }

        .nav-tab.active {
            color: var(--accent-gold);
            background: rgba(212, 168, 83, 0.1);
        }

        .nav-tab.active::before {
            width: 80%;
        }

        /* ============ SECTIONS ============ */
        .section {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-xl);
            padding: 32px;
            margin-bottom: 30px;
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-md);
            transition: all 0.4s ease;
            animation: fadeInUp 0.6s ease;
        }

        .section:hover {
            border-color: var(--border-glow);
            box-shadow: var(--shadow-glow);
        }

        .hidden-section {
            display: none !important;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 28px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-primary);
        }

        .section-title-group {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .section-icon {
            width: 52px;
            height: 52px;
            background: var(--gradient-primary);
            border: 2px solid var(--border-accent);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .section-title {
            font-family: var(--font-display);
            font-weight: 700;
            font-size: 1.4rem;
            color: var(--text-primary);
            margin: 0;
        }

        .section-subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .section-badge {
            background: var(--gradient-accent);
            color: var(--primary-900);
            font-family: var(--font-mono);
            font-size: 0.65rem;
            font-weight: 700;
            padding: 6px 14px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .export-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* ============ STATS GRID ============ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            position: relative;
            background: linear-gradient(135deg, var(--bg-elevated) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 24px 20px;
            text-align: center;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-accent);
            transform: scaleX(0);
            transition: transform 0.4s ease;
        }

        .stat-card:hover {
            transform: translateY(-8px);
            border-color: var(--accent-gold);
            box-shadow: var(--shadow-gold);
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        .stat-value {
            font-family: var(--font-display);
            font-size: clamp(1.6rem, 3vw, 2.2rem);
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .stat-label {
            font-family: var(--font-secondary);
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-sublabel {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .stat-progress {
            background: var(--bg-primary);
            border-radius: 10px;
            height: 6px;
            overflow: hidden;
            margin-top: 12px;
        }

        .stat-progress-fill {
            height: 100%;
            border-radius: 10px;
            background: var(--gradient-accent);
            transition: width 1s ease;
            position: relative;
        }

        .stat-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* ============ CHARTS ============ */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .chart-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            border-color: var(--border-glow);
            box-shadow: var(--shadow-glow);
        }

        .chart-card h4 {
            font-family: var(--font-primary);
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        canvas {
            max-height: 300px;
            width: 100% !important;
        }

        /* ============ TABLES ============ */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-primary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-family: var(--font-primary);
            font-size: 0.9rem;
        }

        th,
        td {
            padding: 16px 14px;
            text-align: left;
            border-bottom: 1px solid var(--border-primary);
            color: var(--text-primary);
        }

        th {
            background: var(--primary-700);
            font-family: var(--font-secondary);
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--primary-100);
            position: sticky;
            top: 0;
        }

        tr {
            transition: background 0.2s ease;
        }

        tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .badge-excellent {
            color: var(--accent-emerald);
            font-weight: 700;
        }

        .badge-good {
            color: var(--accent-gold);
            font-weight: 700;
        }

        .badge-poor {
            color: var(--accent-crimson);
            font-weight: 700;
        }

        /* ============ SEARCH & FILTER ============ */
        .search-filter {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }

        .search-input,
        .filter-select {
            padding: 14px 18px;
            font-family: var(--font-primary);
            font-size: 0.9rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-primary);
            background: var(--bg-secondary);
            color: var(--text-primary);
            flex: 1;
            min-width: 200px;
            transition: all 0.3s ease;
        }

        .search-input:focus,
        .filter-select:focus {
            outline: none;
            border-color: var(--primary-400);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* ============ GEO SECTION ============ */
        .geo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 1024px) {
            .geo-grid {
                grid-template-columns: 1fr;
            }
        }

        .geo-map-container {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        #map {
            height: 320px;
            width: 100%;
        }

        .geo-insights {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .geo-insight-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
        }

        .geo-insight-card:hover {
            border-color: var(--border-accent);
            transform: translateX(4px);
        }

        .geo-insight-icon {
            width: 52px;
            height: 52px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .geo-insight-icon.gold {
            background: rgba(212, 168, 83, 0.15);
        }

        .geo-insight-icon.blue {
            background: rgba(59, 130, 246, 0.15);
        }

        .geo-insight-icon.green {
            background: rgba(5, 150, 105, 0.15);
        }

        .geo-insight-icon.purple {
            background: rgba(124, 58, 237, 0.15);
        }

        .geo-insight-content {
            flex: 1;
        }

        .geo-insight-value {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .geo-insight-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* ============ INSIGHTS SECTION ============ */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }

        .insight-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            padding: 20px;
            border-left: 4px solid var(--accent-gold);
            transition: all 0.3s ease;
        }

        .insight-card:hover {
            border-color: var(--border-accent);
            transform: translateX(4px);
        }

        .insight-card.success {
            border-left-color: var(--accent-emerald);
        }

        .insight-card.warning {
            border-left-color: var(--accent-amber);
        }

        .insight-card.danger {
            border-left-color: var(--accent-crimson);
        }

        .insight-card.info {
            border-left-color: var(--primary-400);
        }

        .insight-card p {
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .insight-card strong {
            color: var(--text-primary);
        }

        /* ============ OVERLAY & POPUP ============ */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(3, 7, 18, 0.9);
            backdrop-filter: blur(8px);
            z-index: 1999;
            display: none;
        }

        .success-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--bg-card);
            border: 2px solid var(--accent-gold);
            border-radius: var(--radius-xl);
            padding: 50px;
            z-index: 2000;
            text-align: center;
            box-shadow: var(--shadow-gold), var(--shadow-lg);
            display: none;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .success-popup.show {
            display: block;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .success-icon {
            width: 90px;
            height: 90px;
            background: var(--gradient-success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 2.5rem;
            color: white;
            box-shadow: 0 0 50px rgba(5, 150, 105, 0.5);
            animation: successPulse 2s ease-in-out infinite;
        }

        @keyframes successPulse {

            0%,
            100% {
                box-shadow: 0 0 50px rgba(5, 150, 105, 0.5);
            }

            50% {
                box-shadow: 0 0 70px rgba(5, 150, 105, 0.7);
            }
        }

        .loading-spinner {
            display: none;
            width: 36px;
            height: 36px;
            border: 4px solid var(--border-primary);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ============ 3D DASHBOARD STYLES ============ */
        /* Core Theme Variables */
        :root {
            /* Fonts */
            --font-display: 'Playfair Display', Georgia, serif;
            --font-primary: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-secondary: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;

            /* Government Deep Blue Theme */
            --primary-900: #0c1929;
            --primary-800: #0f2744;
            --primary-700: #1a365d;
            --primary-600: #234876;
            --primary-500: #2b5a8f;
            --primary-400: #3d7cb8;
            --primary-300: #5a9bd4;
            --primary-200: #89bce8;
            --primary-100: #c4def5;
            --primary-50: #e8f4fc;

            /* Accents */
            --accent-gold: #d4a853;
            --accent-gold-light: #f4d794;
            --accent-emerald: #059669;
            --accent-crimson: #dc2626;

            /* Dimensions */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        /* 3D Stat Cards */
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-xl);
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        .stat-card:hover {
            transform: translateY(-10px) rotateX(5deg);
            box-shadow:
                0 20px 40px -10px rgba(0, 0, 0, 0.6),
                0 0 20px rgba(59, 130, 246, 0.2);
            border-color: var(--accent-gold);
            z-index: 10;
        }

        /* 3D Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-lg);
            border-left: 4px solid var(--accent-gold);
            backdrop-filter: blur(10px);
        }

        .section-title-group {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .section-icon {
            font-size: 2rem;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        /* Chart Containers */
        .chart-container-3d {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-xl);
            padding: 20px;
            box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease;
        }

        .chart-container-3d:hover {
            transform: translateY(-5px);
            border-color: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body data-theme="dark">
    <!-- 3D Hub Portal -->
    <div id="hub-portal">
        <div class="hub-background"></div>
        <h1 class="hub-title">National Rural Livelihoods Mission</h1>
        <div class="hub-cards-container">
            <div class="hub-card" onclick="openDashboard('shg')">
                <div class="hub-card-icon">üèõÔ∏è</div>
                <h2 class="hub-card-title">SHG Analytics</h2>
                <p class="hub-card-desc">Comprehensive analysis of Self Help Groups, financial inclusion, and block-wise
                    performance metrics.</p>
                <button class="hub-card-btn">Enter Dashboard</button>
            </div>
            <div class="hub-card" onclick="openDashboard('member')">
                <div class="hub-card-icon">üë•</div>
                <h2 class="hub-card-title">Member Analysis</h2>
                <p class="hub-card-desc">Deep dive into member demographics, social categories, and individual
                    livelihood tracking.</p>
                <button class="hub-card-btn">Enter Dashboard</button>
            </div>
        </div>
    </div>

    <!-- Back to Hub Button -->
    <div id="backToHub" class="back-to-hub-btn" onclick="returnToHub()">
        <span>‚Ü©</span>
    </div>

    <!-- Member Dashboard View (Full Screen Iframe) -->
    <div id="member-dashboard-view">
        <iframe id="member-frame" src="about:blank"></iframe>
    </div>

    <!-- Main SHG Dashboard Content (Wrapped) -->
    <div id="shg-dashboard-container" class="dashboard-container dashboard-hidden">
        <!-- Theme Toggle -->
        <button class="theme-toggle" onclick="toggleTheme()">üåô</button>

        <!-- Toast Notification -->
        <div id="toast" class="toast">
            <span class="toast-icon">‚úÖ</span>
            <span class="toast-message" id="toastMessage">Export successful!</span>
        </div>

        <!-- Overlay & Popup -->
        <div id="overlay" class="overlay"></div>
        <div id="successPopup" class="success-popup">
            <div class="success-icon">‚úì</div>
            <h2
                style="font-family: var(--font-display); font-size: 1.8rem; color: var(--accent-gold); margin-bottom: 12px;">
                Analysis Complete!</h2>
            <p style="color: var(--text-secondary); margin-bottom: 28px; font-size: 1rem;">Your SHG data has been
                processed successfully. Dashboard is ready.</p>
            <button class="btn-primary" onclick="closeSuccessPopup()">View Dashboard</button>
        </div>

        <!-- Government Header -->
        <header class="gov-header">
            <div class="gov-top-bar">
                <div class="gov-emblem">
                    <div class="gov-emblem-icon">üèõÔ∏è</div>
                    <span style="font-weight: 600; color: var(--text-primary);">Ministry of Rural Development</span>
                </div>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <span>üáÆüá≥ Government of India Initiative</span>
                    <span style="color: var(--accent-gold);">|</span>
                    <span>Tamil Nadu State Mission</span>
                </div>
            </div>
            <div class="gov-main-header"
                style="width: 100%; padding: 20px 24px; display: flex; justify-content: space-between; align-items: center;">
                <div class="header-left">
                    <div class="gov-title-badge"
                        style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; background: rgba(212, 168, 83, 0.1); border: 1px solid rgba(212, 168, 83, 0.2); border-radius: 20px; margin-bottom: 10px;">
                        <span>‚ö°</span>
                        <span style="font-size: 0.85rem; color: var(--accent-gold); font-weight: 600;">National Rural
                            Livelihoods Mission</span>
                    </div>
                    <h1 class="gov-title"
                        style="font-family: var(--font-display); font-size: 2.2rem; color: white; letter-spacing: -0.5px; margin-bottom: 6px;">
                        SHG <span
                            style="background: var(--gradient-accent); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Analytics
                            Pro</span>
                    </h1>
                    <p class="gov-subtitle"
                        style="display: flex; align-items: center; gap: 10px; color: var(--text-secondary); font-size: 0.95rem;">
                        <span>Project Director Suite</span>
                        <span
                            style="width: 4px; height: 4px; background: var(--text-muted); border-radius: 50%;"></span>
                        <span>Real-time MIS Dashboard</span>
                    </p>
                </div>
                <div class="state-branding" style="text-align: right;">
                    <div style="font-size: 3rem; opacity: 0.2; filter: grayscale(1);">ü¶Å</div>
                </div>
            </div>
        </header>

        <div class="container">
            <!-- Upload Section -->
            <div class="upload-section" id="uploadSection"
                style="max-width: 600px; margin: 0 auto 40px; text-align: center; padding: 40px; background: rgba(255,255,255,0.02); border: 1px dashed var(--accent-gold); border-radius: 24px;">
                <div class="upload-icon" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.8;">üìÇ</div>
                <h2 class="upload-title"
                    style="font-family: var(--font-display); font-size: 1.8rem; color: white; margin-bottom: 10px;">
                    Upload SHG Data File</h2>
                <p class="upload-desc" style="color: var(--text-secondary); margin-bottom: 30px;">Upload your TN NRLM
                    MIS Excel file (.xlsx) for comprehensive analysis.</p>

                <div class="upload-controls"
                    style="display: flex; gap: 12px; justify-content: center; align-items: center;">
                    <input type="file" id="excelFile" accept=".xlsx,.xls"
                        style="background: rgba(0,0,0,0.3); color: white; padding: 10px 20px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;" />
                    <button class="btn-primary" id="uploadBtn" onclick="processExcel()"
                        style="padding: 12px 24px; background: var(--gradient-accent); border: none; border-radius: 8px; color: var(--primary-900); font-weight: 600; cursor: pointer; transition: transform 0.2s;">
                        üîç Analyze Data
                    </button>
                </div>
                <div class="loading-spinner" id="loadingSpinner"></div>
                <p id="statusText"
                    style="margin-top: 20px; color: var(--accent-gold); font-family: var(--font-mono); font-weight: 500;">
                </p>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs" id="navTabs">
                <button class="nav-tab active" onclick="showSection('overview')">üìä Overview</button>
                <button class="nav-tab" onclick="showSection('fyFormation')">üìÖ FY Formation</button>
                <button class="nav-tab" onclick="showSection('financial')">üí∞ Financial</button>
                <button class="nav-tab" onclick="showSection('block')">üèòÔ∏è Blocks</button>
                <button class="nav-tab" onclick="showSection('bank')">üè¶ Banks</button>
                <button class="nav-tab" onclick="showSection('member')">üë• Members</button>
                <button class="nav-tab" onclick="showSection('livelihood')">üåæ Livelihood</button>
                <button class="nav-tab" onclick="showSection('geo')">üó∫Ô∏è Geography</button>
                <button class="nav-tab" onclick="showSection('insights')">ü§ñ AI Insights</button>
            </div>

            <!-- All Sections -->
            <div id="overviewSection" class="section hidden-section"></div>
            <div id="fyFormationSection" class="section hidden-section"></div>
            <div id="financialSection" class="section hidden-section"></div>
            <div id="blockSection" class="section hidden-section"></div>
            <div id="bankSection" class="section hidden-section"></div>
            <div id="memberSection" class="section hidden-section"></div>
            <div id="livelihoodSection" class="section hidden-section"></div>
            <div id="geoSection" class="section hidden-section"></div>
            <div id="insightsSection" class="section hidden-section"></div>
        </div>

        <!-- Footer -->
        <footer class="gov-footer">
            <div class="gov-footer-content">
                <div class="gov-footer-logo">
                    <span style="font-size: 1.5rem;">üèõÔ∏è</span>
                    <span style="font-family: var(--font-display); font-weight: 700; color: var(--text-primary);">SHG
                        Analytics Pro</span>
                </div>
                <p class="gov-footer-text">
                    A Digital India Initiative | National Rural Livelihoods Mission<br>
                    Ministry of Rural Development, Government of India
                </p>
                <div class="gov-footer-links">
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#">Help & Support</a>
                    <a href="#">Contact Us</a>
                </div>
            </div>
        </footer>
    </div> <!-- End of shg-dashboard-container -->

    <script>
        // ============ 3D PORTAL LOGIC ============
        function openDashboard(type) {
            const hub = document.getElementById('hub-portal');
            const backBtn = document.getElementById('backToHub');
            const shgContainer = document.getElementById('shg-dashboard-container');
            const memberView = document.getElementById('member-dashboard-view');
            const memberFrame = document.getElementById('member-frame');

            // Hide Hub
            hub.classList.add('hidden-portal');
            backBtn.classList.add('visible');

            if (type === 'shg') {
                // Show SHG Dashboard
                shgContainer.classList.remove('dashboard-hidden');
                // Ensure Member View is hidden
                memberView.classList.remove('active-view');
            } else if (type === 'member') {
                // Show Member Dashboard
                memberView.classList.add('active-view');
                shgContainer.classList.add('dashboard-hidden');

                // Load iframe if empty
                if (memberFrame.src === 'about:blank') {
                    memberFrame.src = 'Member_Dashboard.html';
                }
            }
        }

        function returnToHub() {
            const hub = document.getElementById('hub-portal');
            const backBtn = document.getElementById('backToHub');
            const shgContainer = document.getElementById('shg-dashboard-container');
            const memberView = document.getElementById('member-dashboard-view');

            // Show Hub
            hub.classList.remove('hidden-portal');
            backBtn.classList.remove('visible');

            // Hide Dashboards
            shgContainer.classList.add('dashboard-hidden');
            memberView.classList.remove('active-view');
        }

        // ============ CONFIGURATION ============
        let originalData = [];
        let analyzedStats = null;
        let charts = {};
        let map = null;

        const COL_MAP = {
            'Block': 'block',
            'SHG Name': 'shgName',
            'SHG Code': 'shgCode',
            'Status (Active/Inactive)': 'status',
            'Date of Formation': 'formationDate',
            '1st Account Number': 'bankAccount',
            '1st Bank Name': 'bankName',
            '1st Branch Name': 'branchName',
            'Active Members': 'members',
            'Savings Amount': 'savings',
            'District': 'district',
            'Gram Panchayat': 'gramPanchayat',
            'Village': 'village',
            'SHG Category': 'category',
            'Special SHG Type': 'specialType',
            'Primary Livelihoods': 'primaryLivelihood',
            'Secondary Livelihoods': 'secondaryLivelihood',
            'Tertiary Livelihoods': 'tertiaryLivelihood',
            'Meeting Frequency': 'meetingFreq',
            'Approval Status': 'approvalStatus'
        };

        // ============ TOAST NOTIFICATION ============
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = toast.querySelector('.toast-icon');

            toastMessage.textContent = message;
            toastIcon.textContent = isError ? '‚ùå' : '‚úÖ';
            toast.classList.toggle('error', isError);
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ============ THEME TOGGLE ============
        function toggleTheme() {
            const body = document.body;
            const next = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', next);
            document.querySelector('.theme-toggle').textContent = next === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('theme', next);
            if (analyzedStats) renderAllSections(analyzedStats);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const theme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', theme);
            document.querySelector('.theme-toggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        });

        // ============ UTILITY FUNCTIONS ============
        function getCol(row, key) {
            for (const [excelCol, mappedKey] of Object.entries(COL_MAP)) {
                if (mappedKey === key && row[excelCol] !== undefined) return row[excelCol];
            }
            const keys = Object.keys(row);
            for (const k of keys) {
                if (k.toLowerCase().includes(key.toLowerCase())) return row[k];
            }
            return '';
        }

        function parseDate(val) {
            if (!val) return null;
            if (typeof val === 'number') return new Date(Math.round((val - 25569) * 86400 * 1000));
            const str = String(val).trim();
            let parts = str.split(/[-/]/);
            if (parts.length === 3) {
                const day = parseInt(parts[0]), month = parseInt(parts[1]) - 1, year = parseInt(parts[2]);
                if (!isNaN(day) && !isNaN(month) && !isNaN(year)) return new Date(year, month, day);
            }
            return new Date(str) || null;
        }

        function isCurrentFY(date) {
            if (!date || isNaN(date)) return false;
            const fyStart = new Date(2025, 3, 1), fyEnd = new Date(2026, 2, 31);
            return date >= fyStart && date <= fyEnd;
        }

        function parseNumber(val) {
            if (val === null || val === undefined || val === '' || val === '-') return 0;
            if (typeof val === 'number') return val;
            return parseFloat(String(val).replace(/[^0-9.-]/g, '')) || 0;
        }

        function formatNumber(num) {
            if (num >= 10000000) return (num / 10000000).toFixed(2) + ' Cr';
            if (num >= 100000) return (num / 100000).toFixed(2) + ' L';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
        }

        function getThemeColors() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            return {
                accent: '#d4a853',
                primary: '#3d7cb8',
                success: '#059669',
                danger: '#dc2626',
                warning: '#f59e0b',
                purple: '#7c3aed',
                cyan: '#06b6d4',
                pink: '#ec4899',
                text: isDark ? '#f8fafc' : '#0f172a',
                grid: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)'
            };
        }

        // ============ SECTION NAVIGATION ============
        function showSection(sectionId) {
            const sections = ['overview', 'fyFormation', 'financial', 'block', 'bank', 'member', 'livelihood', 'geo', 'insights'];
            sections.forEach(s => document.getElementById(s + 'Section').classList.add('hidden-section'));
            document.getElementById(sectionId + 'Section').classList.remove('hidden-section');

            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            if (sectionId === 'geo' && map) setTimeout(() => map.invalidateSize(), 100);
        }

        // ============ DATA ANALYSIS ============
        function analyzeData(data) {
            const stats = {
                total: data.length,
                active: 0, inactive: 0,
                fyFormed: 0, fyWomanRegular: 0, fySpecial: 0,
                fySpecialTypes: {}, fyMonthly: {}, fyYearly: {},
                totalMembers: 0, totalSavings: 0,
                savingsBrackets: { '‚Çπ0': 0, '‚Çπ1-1K': 0, '‚Çπ1K-5K': 0, '‚Çπ5K-10K': 0, '‚Çπ10K-50K': 0, '‚Çπ50K+': 0 },
                bankLinked: 0,
                blocks: {}, banks: {}, branches: {},
                livelihoods: {}, meetingFreq: {}, approvalStatus: {},
                memberCompliance: { womanLow: 0, specialLow: 0, total: 0 },
                geoData: { districts: {}, gramPanchayats: {}, villages: {} }
            };

            data.forEach(row => {
                const status = String(getCol(row, 'status')).toLowerCase().trim();
                const isActive = status === 'active' || (!status.includes('inactive') && status !== '');

                if (isActive) {
                    stats.active++;

                    const block = String(getCol(row, 'block') || 'Unknown').trim().toUpperCase();
                    const members = parseNumber(getCol(row, 'members'));
                    const savings = parseNumber(getCol(row, 'savings'));
                    const bankAccount = String(getCol(row, 'bankAccount') || '').trim();
                    const bankName = String(getCol(row, 'bankName') || '').trim();
                    const branchName = String(getCol(row, 'branchName') || '').trim();
                    const formationDate = parseDate(getCol(row, 'formationDate'));
                    const specialType = String(getCol(row, 'specialType') || '').trim();
                    const primaryLivelihood = String(getCol(row, 'primaryLivelihood') || '').trim();
                    const meetingFreq = String(getCol(row, 'meetingFreq') || '').trim();
                    const approvalStatus = String(getCol(row, 'approvalStatus') || '').trim();
                    const district = String(getCol(row, 'district') || '').trim();
                    const gp = String(getCol(row, 'gramPanchayat') || '').trim();
                    const village = String(getCol(row, 'village') || '').trim();

                    stats.totalMembers += members;
                    stats.totalSavings += savings;

                    if (savings === 0) stats.savingsBrackets['‚Çπ0']++;
                    else if (savings <= 1000) stats.savingsBrackets['‚Çπ1-1K']++;
                    else if (savings <= 5000) stats.savingsBrackets['‚Çπ1K-5K']++;
                    else if (savings <= 10000) stats.savingsBrackets['‚Çπ5K-10K']++;
                    else if (savings <= 50000) stats.savingsBrackets['‚Çπ10K-50K']++;
                    else stats.savingsBrackets['‚Çπ50K+']++;

                    const hasBank = bankAccount.length > 5 && !bankAccount.match(/^0+$/) && bankAccount.toLowerCase() !== 'na';
                    if (hasBank) stats.bankLinked++;

                    if (meetingFreq && meetingFreq !== '-') stats.meetingFreq[meetingFreq] = (stats.meetingFreq[meetingFreq] || 0) + 1;
                    if (approvalStatus && approvalStatus !== '-') stats.approvalStatus[approvalStatus] = (stats.approvalStatus[approvalStatus] || 0) + 1;

                    if (formationDate && isCurrentFY(formationDate)) {
                        stats.fyFormed++;
                        const monthKey = formationDate.toLocaleString('default', { month: 'short', year: 'numeric' });
                        stats.fyMonthly[monthKey] = (stats.fyMonthly[monthKey] || 0) + 1;

                        if (specialType === '-' || specialType === '' || specialType.toLowerCase() === 'undefined') {
                            stats.fyWomanRegular++;
                        } else {
                            stats.fySpecial++;
                            stats.fySpecialTypes[specialType] = (stats.fySpecialTypes[specialType] || 0) + 1;
                        }
                    }

                    if (formationDate) {
                        const year = formationDate.getFullYear();
                        if (year >= 2015 && year <= 2026) stats.fyYearly[year] = (stats.fyYearly[year] || 0) + 1;
                    }

                    if (!stats.blocks[block]) {
                        stats.blocks[block] = { total: 0, members: 0, savings: 0, bankLinked: 0, fyFormed: 0, fyWoman: 0, fySpecial: 0, womanLow: 0, specialLow: 0 };
                    }
                    stats.blocks[block].total++;
                    stats.blocks[block].members += members;
                    stats.blocks[block].savings += savings;
                    if (hasBank) stats.blocks[block].bankLinked++;
                    if (formationDate && isCurrentFY(formationDate)) {
                        stats.blocks[block].fyFormed++;
                        if (specialType === '-' || specialType === '') stats.blocks[block].fyWoman++;
                        else stats.blocks[block].fySpecial++;
                    }

                    const isWomanReg = specialType === '-' || specialType === '' || specialType.toLowerCase() === 'undefined';
                    if (isWomanReg && members < 12 && members > 0) {
                        stats.memberCompliance.womanLow++;
                        stats.memberCompliance.total++;
                        stats.blocks[block].womanLow++;
                    } else if (!isWomanReg && members < 5 && members > 0) {
                        stats.memberCompliance.specialLow++;
                        stats.memberCompliance.total++;
                        stats.blocks[block].specialLow++;
                    }

                    if (bankName && bankName !== '-') {
                        stats.banks[bankName] = (stats.banks[bankName] || 0) + 1;
                        if (branchName && branchName !== '-') {
                            const branchKey = `${block}|||${bankName}|||${branchName}`;
                            stats.branches[branchKey] = (stats.branches[branchKey] || 0) + 1;
                        }
                    }

                    if (primaryLivelihood && primaryLivelihood !== '-') stats.livelihoods[primaryLivelihood] = (stats.livelihoods[primaryLivelihood] || 0) + 1;

                    if (district) stats.geoData.districts[district] = (stats.geoData.districts[district] || 0) + 1;
                    if (gp) stats.geoData.gramPanchayats[gp] = (stats.geoData.gramPanchayats[gp] || 0) + 1;
                    if (village) stats.geoData.villages[village] = (stats.geoData.villages[village] || 0) + 1;
                } else {
                    stats.inactive++;
                }
            });

            return stats;
        }



        function renderFYSection(stats) {
            const colors = getThemeColors();
            const specialEntries = Object.entries(stats.fySpecialTypes).sort((a, b) => b[1] - a[1]);
            const typeLabels = ['Woman Regular', ...specialEntries.map(e => e[0])];
            const typeData = [stats.fyWomanRegular, ...specialEntries.map(e => e[1])];

            document.getElementById('fyFormationSection').innerHTML = `
                <div class="section-header">
                    <div class="section-title-group">
                        <div class="section-icon">üìÖ</div>
                        <div>
                            <h3 class="section-title">FY 2025-26 Formation Analysis</h3>
                            <p class="section-subtitle">New SHG registrations during current financial year</p>
                        </div>
                    </div>
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToCSV('fyFormation')">üì• CSV</button>
                        <button class="btn-export" onclick="exportToPDF('fyFormation')">üìÑ PDF</button>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon">üìÖ</div><div class="stat-value">${stats.fyFormed}</div><div class="stat-label">Total FY Formed</div></div>
                    <div class="stat-card"><div class="stat-icon">üë©</div><div class="stat-value">${stats.fyWomanRegular}</div><div class="stat-label">Woman Regular</div></div>
                    <div class="stat-card"><div class="stat-icon">‚≠ê</div><div class="stat-value">${stats.fySpecial}</div><div class="stat-label">Special SHGs</div></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-card"><h4>üë© Woman Regular vs Special</h4><canvas id="fyTypeChart"></canvas></div>
                    <div class="chart-card"><h4>üìà Monthly Trend</h4><canvas id="fyTrendChart"></canvas></div>
                    <div class="chart-card"><h4>üìä Yearly History</h4><canvas id="fyYearlyChart"></canvas></div>
                </div>
                <div class="table-container"><table id="fyFormationTable"><thead><tr><th>Block</th><th>Woman Reg</th><th>Special</th><th>Total</th></tr></thead><tbody>${Object.entries(stats.blocks).filter(([_, d]) => d.fyFormed > 0).sort((a, b) => b[1].fyFormed - a[1].fyFormed).map(([block, data]) => `<tr><td>${block}</td><td>${data.fyWoman}</td><td>${data.fySpecial}</td><td class="badge-excellent">${data.fyFormed}</td></tr>`).join('')}</tbody></table></div>
            `;

            if (charts.fyType) charts.fyType.destroy();
            charts.fyType = new Chart(document.getElementById('fyTypeChart').getContext('2d'), {
                type: 'doughnut',
                data: { labels: typeLabels, datasets: [{ data: typeData, backgroundColor: [colors.success, colors.primary, colors.warning, colors.purple, colors.cyan, colors.pink], borderWidth: 0 }] },
                options: { responsive: true, plugins: { legend: { position: 'right', labels: { color: colors.text, font: { size: 10 } } }, datalabels: { color: '#fff', formatter: v => v, font: { size: 10 } } } }
            });

            const monthlyData = Object.entries(stats.fyMonthly).sort((a, b) => new Date(a[0]) - new Date(b[0]));
            if (charts.fyTrend) charts.fyTrend.destroy();
            charts.fyTrend = new Chart(document.getElementById('fyTrendChart').getContext('2d'), {
                type: 'line',
                data: { labels: monthlyData.map(m => m[0]), datasets: [{ label: 'SHGs Formed', data: monthlyData.map(m => m[1]), borderColor: colors.accent, backgroundColor: colors.accent + '33', fill: true, tension: 0.4, pointRadius: 4, pointBackgroundColor: colors.accent }] },
                options: { responsive: true, plugins: { legend: { labels: { color: colors.text } }, datalabels: { display: false } }, scales: { x: { ticks: { color: colors.text }, grid: { color: colors.grid } }, y: { ticks: { color: colors.text }, grid: { color: colors.grid } } } }
            });

            const yearlyData = Object.entries(stats.fyYearly).sort((a, b) => a[0] - b[0]);
            if (charts.fyYearly) charts.fyYearly.destroy();
            charts.fyYearly = new Chart(document.getElementById('fyYearlyChart').getContext('2d'), {
                type: 'bar',
                data: { labels: yearlyData.map(y => y[0]), datasets: [{ label: 'SHGs', data: yearlyData.map(y => y[1]), backgroundColor: colors.primary, borderRadius: 6 }] },
                options: { responsive: true, plugins: { legend: { display: false }, datalabels: { color: colors.text, anchor: 'end', align: 'top', font: { size: 10 } } }, scales: { x: { ticks: { color: colors.text }, grid: { display: false } }, y: { ticks: { color: colors.text }, grid: { color: colors.grid } } } }
            });
        }

        function renderFinancialSection(stats) {
            const colors = getThemeColors();
            const avgSavings = stats.active > 0 ? Math.round(stats.totalSavings / stats.active) : 0;
            const maxSavingsBlock = Object.entries(stats.blocks).sort((a, b) => b[1].savings - a[1].savings)[0];

            document.getElementById('financialSection').innerHTML = `
                <div class="section-header">
                    <div class="section-title-group">
                        <div class="section-icon">üí∞</div>
                        <div>
                            <h3 class="section-title">Financial Health Analysis</h3>
                            <p class="section-subtitle">Savings distribution and financial metrics</p>
                        </div>
                    </div>
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToCSV('financial')">üì• CSV</button>
                        <button class="btn-export" onclick="exportToPDF('financial')">üìÑ PDF</button>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon">üí∞</div><div class="stat-value">‚Çπ${formatNumber(stats.totalSavings)}</div><div class="stat-label">Total Savings</div></div>
                    <div class="stat-card"><div class="stat-icon">üìä</div><div class="stat-value">‚Çπ${formatNumber(avgSavings)}</div><div class="stat-label">Avg per SHG</div></div>
                    <div class="stat-card"><div class="stat-icon">üèÜ</div><div class="stat-value">${maxSavingsBlock ? maxSavingsBlock[0] : '-'}</div><div class="stat-label">Top Block</div></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-card"><h4>üí∞ Savings Distribution</h4><canvas id="savingsDistChart"></canvas></div>
                    <div class="chart-card"><h4>üìä Block-wise Savings</h4><canvas id="blockSavingsChart"></canvas></div>
                </div>
                <div class="table-container"><table id="financialTable"><thead><tr><th>Block</th><th>SHGs</th><th>Total Savings</th><th>Avg Savings</th></tr></thead><tbody>${Object.entries(stats.blocks).sort((a, b) => b[1].savings - a[1].savings).map(([block, data]) => `<tr><td>${block}</td><td>${data.total}</td><td>‚Çπ${formatNumber(data.savings)}</td><td>‚Çπ${formatNumber(data.total > 0 ? Math.round(data.savings / data.total) : 0)}</td></tr>`).join('')}</tbody></table></div>
            `;

            if (charts.savingsDist) charts.savingsDist.destroy();
            charts.savingsDist = new Chart(document.getElementById('savingsDistChart').getContext('2d'), {
                type: 'bar',
                data: { labels: Object.keys(stats.savingsBrackets), datasets: [{ label: 'SHGs', data: Object.values(stats.savingsBrackets), backgroundColor: [colors.danger, colors.warning, colors.primary, colors.success, colors.purple, colors.cyan], borderRadius: 6 }] },
                options: { responsive: true, plugins: { legend: { display: false }, datalabels: { color: colors.text, anchor: 'end', align: 'top', font: { size: 10 } } }, scales: { x: { ticks: { color: colors.text }, grid: { display: false } }, y: { ticks: { color: colors.text }, grid: { color: colors.grid } } } }
            });

            const blockSavings = Object.entries(stats.blocks).sort((a, b) => b[1].savings - a[1].savings).slice(0, 10);
            if (charts.blockSavings) charts.blockSavings.destroy();
            charts.blockSavings = new Chart(document.getElementById('blockSavingsChart').getContext('2d'), {
                type: 'bar',
                data: { labels: blockSavings.map(b => b[0]), datasets: [{ label: 'Savings', data: blockSavings.map(b => b[1].savings), backgroundColor: colors.accent, borderRadius: 6 }] },
                options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false }, datalabels: { color: colors.text, formatter: v => '‚Çπ' + formatNumber(v), font: { size: 9 } } }, scales: { x: { ticks: { color: colors.text }, grid: { color: colors.grid } }, y: { ticks: { color: colors.text }, grid: { display: false } } } }
            });
        }

        function renderBlockSection(stats) {
            const colors = getThemeColors();
            // Sort by Bank Linkage % Descending
            const sortedBlocks = Object.entries(stats.blocks).sort((a, b) => {
                const pctA = a[1].total > 0 ? (a[1].bankLinked / a[1].total) : 0;
                const pctB = b[1].total > 0 ? (b[1].bankLinked / b[1].total) : 0;
                return pctB - pctA;
            });

            document.getElementById('blockSection').innerHTML = `
                <div class="section-header">
                    <div class="section-title-group">
                        <div class="section-icon">üèòÔ∏è</div>
                        <div>
                            <h3 class="section-title">Block-wise Performance</h3>
                            <p class="section-subtitle">Comprehensive analysis by administrative blocks</p>
                        </div>
                    </div>
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToCSV('block')">üì• CSV</button>
                        <button class="btn-export" onclick="exportToPDF('block')">üìÑ PDF</button>
                    </div>
                </div>
                <div class="search-filter">
                    <input type="text" class="search-input" id="blockSearch" placeholder="üîç Search blocks..." onkeyup="filterTable('blockTable', this.value)" />
                    <select class="filter-select" onchange="filterTableByStatus('blockTable', this.value)">
                        <option value="">All Status</option>
                        <option value="excellent">Excellent (>90%)</option>
                        <option value="good">Good (70-90%)</option>
                        <option value="poor">Needs Focus (<70%)</option>
                    </select>
                </div>
                <div class="charts-grid">
                    <div class="chart-card"><h4>üèòÔ∏è Top 10 Blocks</h4><canvas id="blockBarChart"></canvas></div>
                    <div class="chart-card"><h4>üè¶ Bank Linkage by Block</h4><canvas id="blockBankChart"></canvas></div>
                </div>
                <div class="table-container"><table id="blockTable"><thead><tr><th>Block</th><th>Total</th><th>Bank Linked</th><th>Bank %</th><th>Members</th><th>FY Formed</th><th>Status</th></tr></thead><tbody>${sortedBlocks.map(([block, data]) => {
                const bankPct = data.total > 0 ? ((data.bankLinked / data.total) * 100).toFixed(0) : 0;
                const status = bankPct >= 90 ? '<span class="badge-excellent">Excellent</span>' : bankPct >= 70 ? '<span class="badge-good">Good</span>' : '<span class="badge-poor">Needs Focus</span>';
                const statusClass = bankPct >= 90 ? 'excellent' : bankPct >= 70 ? 'good' : 'poor';
                return `<tr data-status="${statusClass}"><td>${block}</td><td>${data.total}</td><td>${data.bankLinked}</td><td>${bankPct}%</td><td>${data.members.toLocaleString()}</td><td>${data.fyFormed}</td><td>${status}</td></tr>`;
            }).join('')}</tbody></table></div>
            `;

            const top10 = sortedBlocks.slice(0, 10);
            if (charts.blockBar) charts.blockBar.destroy();
            charts.blockBar = new Chart(document.getElementById('blockBarChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: top10.map(b => b[0]), datasets: [
                        { label: 'Total', data: top10.map(b => b[1].total), backgroundColor: colors.accent, borderRadius: 6 },
                        { label: 'Bank Linked', data: top10.map(b => b[1].bankLinked), backgroundColor: colors.primary, borderRadius: 6 }
                    ]
                },
                options: { responsive: true, plugins: { legend: { labels: { color: colors.text } }, datalabels: { display: false } }, scales: { x: { ticks: { color: colors.text }, grid: { display: false } }, y: { ticks: { color: colors.text }, grid: { color: colors.grid } } } }
            });

            if (charts.blockBank) charts.blockBank.destroy();
            charts.blockBank = new Chart(document.getElementById('blockBankChart').getContext('2d'), {
                type: 'bar',
                data: { labels: top10.map(b => b[0]), datasets: [{ label: 'Bank %', data: top10.map(b => b[1].total > 0 ? ((b[1].bankLinked / b[1].total) * 100).toFixed(1) : 0), backgroundColor: top10.map(b => { const pct = b[1].total > 0 ? (b[1].bankLinked / b[1].total) * 100 : 0; return pct >= 90 ? colors.success : pct >= 70 ? colors.warning : colors.danger; }), borderRadius: 6 }] },
                options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false }, datalabels: { color: colors.text, formatter: v => v + '%', font: { size: 10 } } }, scales: { x: { max: 100, ticks: { color: colors.text }, grid: { color: colors.grid } }, y: { ticks: { color: colors.text }, grid: { display: false } } } }
            });
        }

        function renderBankSection(stats) {
            const colors = getThemeColors();
            const bankArray = Object.entries(stats.banks).sort((a, b) => b[1] - a[1]);

            document.getElementById('bankSection').innerHTML = `
                < div class="section-header" >
                    <div class="section-title-group">
                        <div class="section-icon">üè¶</div>
                        <div>
                            <h3 class="section-title">Bank Linkage Analysis</h3>
                            <p class="section-subtitle">Financial inclusion and banking partnerships</p>
                        </div>
                    </div>
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToCSV('bank')">üì• CSV</button>
                        <button class="btn-export" onclick="exportToPDF('bank')">üìÑ PDF</button>
                    </div>
                </div >
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon">üè¶</div><div class="stat-value">${bankArray.length}</div><div class="stat-label">Banks Connected</div></div>
                    <div class="stat-card"><div class="stat-icon">üìç</div><div class="stat-value">${Object.keys(stats.branches).length}</div><div class="stat-label">Branch Locations</div></div>
                    <div class="stat-card"><div class="stat-icon">üîó</div><div class="stat-value">${stats.bankLinked.toLocaleString()}</div><div class="stat-label">SHGs Linked</div></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-card"><h4>üè¶ Top Banks</h4><canvas id="bankPieChart"></canvas></div>
                </div>
                <div class="table-container"><table id="bankTable"><thead><tr><th>#</th><th>Bank</th><th>Accounts</th></tr></thead><tbody>${bankArray.map((bank, i) => `<tr><td>${i + 1}</td><td>${bank[0]}</td><td class="badge-excellent">${bank[1]}</td></tr>`).join('')}</tbody></table></div>
            `;

            const top8 = bankArray.slice(0, 8);
            if (charts.bankPie) charts.bankPie.destroy();
            charts.bankPie = new Chart(document.getElementById('bankPieChart').getContext('2d'), {
                type: 'doughnut',
                data: { labels: top8.map(b => b[0].length > 20 ? b[0].substring(0, 20) + '...' : b[0]), datasets: [{ data: top8.map(b => b[1]), backgroundColor: [colors.accent, colors.primary, colors.warning, colors.danger, colors.purple, colors.cyan, colors.pink, colors.success], borderWidth: 0 }] },
                options: { responsive: true, plugins: { legend: { position: 'right', labels: { color: colors.text, font: { size: 10 } } }, datalabels: { color: '#fff', formatter: v => v, font: { size: 10 } } } }
            });
        }

        function renderMemberSection(stats) {
            const colors = getThemeColors();
            const complianceRate = stats.active > 0 ? (((stats.active - stats.memberCompliance.total) / stats.active) * 100).toFixed(1) : 100;

            document.getElementById('memberSection').innerHTML = `
                < div class="section-header" >
                    <div class="section-title-group">
                        <div class="section-icon">üë•</div>
                        <div>
                            <h3 class="section-title">Member Compliance Analysis</h3>
                            <p class="section-subtitle">Minimum member requirements monitoring</p>
                        </div>
                    </div>
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToCSV('member')">üì• CSV</button>
                        <button class="btn-export" onclick="exportToPDF('member')">üìÑ PDF</button>
                    </div>
                </div >
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon">‚ö†Ô∏è</div><div class="stat-value" style="color: var(--accent-crimson);">${stats.memberCompliance.total}</div><div class="stat-label">Non-Compliant</div></div>
                    <div class="stat-card"><div class="stat-icon">üë©</div><div class="stat-value">${stats.memberCompliance.womanLow}</div><div class="stat-label">Woman Reg (&lt;12)</div></div>
                    <div class="stat-card"><div class="stat-icon">‚≠ê</div><div class="stat-value">${stats.memberCompliance.specialLow}</div><div class="stat-label">Special (&lt;5)</div></div>
                    <div class="stat-card"><div class="stat-icon">‚úÖ</div><div class="stat-value">${complianceRate}%</div><div class="stat-label">Compliance Rate</div></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-card"><h4>üë• Compliance Breakdown</h4><canvas id="memberChart"></canvas></div>
                </div>
                <div class="table-container"><table id="memberTable"><thead><tr><th>Block</th><th>Woman Reg (&lt;12)</th><th>Special (&lt;5)</th><th>Total</th></tr></thead><tbody>${Object.entries(stats.blocks).filter(([_, d]) => d.womanLow + d.specialLow > 0).sort((a, b) => (b[1].womanLow + b[1].specialLow) - (a[1].womanLow + a[1].specialLow)).map(([block, data]) => `<tr><td>${block}</td><td>${data.womanLow}</td><td>${data.specialLow}</td><td class="badge-poor">${data.womanLow + data.specialLow}</td></tr>`).join('')}</tbody></table></div>
            `;

            if (charts.member) charts.member.destroy();
            charts.member = new Chart(document.getElementById('memberChart').getContext('2d'), {
                type: 'doughnut',
                data: { labels: ['Compliant', 'Woman Reg Low', 'Special Low'], datasets: [{ data: [stats.active - stats.memberCompliance.total, stats.memberCompliance.womanLow, stats.memberCompliance.specialLow], backgroundColor: [colors.success, colors.warning, colors.danger], borderWidth: 0 }] },
                options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: colors.text } }, datalabels: { color: '#fff', formatter: v => v, font: { weight: '600' } } } }
            });
        }

        function renderLivelihoodSection(stats) {
            const colors = getThemeColors();
            const livArray = Object.entries(stats.livelihoods).sort((a, b) => b[1] - a[1]);
            const totalWithLiv = livArray.reduce((sum, l) => sum + l[1], 0);

            document.getElementById('livelihoodSection').innerHTML = `
                < div class="section-header" >
                    <div class="section-title-group">
                        <div class="section-icon">üåæ</div>
                        <div>
                            <h3 class="section-title">Livelihood Mapping</h3>
                            <p class="section-subtitle">Economic activity distribution analysis</p>
                        </div>
                    </div>
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToCSV('livelihood')">üì• CSV</button>
                        <button class="btn-export" onclick="exportToPDF('livelihood')">üìÑ PDF</button>
                    </div>
                </div >
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon">üåæ</div><div class="stat-value">${livArray.length}</div><div class="stat-label">Unique Livelihoods</div></div>
                    <div class="stat-card"><div class="stat-icon">üìä</div><div class="stat-value">${totalWithLiv.toLocaleString()}</div><div class="stat-label">SHGs with Data</div></div>
                    <div class="stat-card"><div class="stat-icon">üéØ</div><div class="stat-value">${livArray.length > 0 ? livArray[0][0].substring(0, 15) : '-'}</div><div class="stat-label">Top Livelihood</div></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-card"><h4>üåæ Top 10 Livelihoods</h4><canvas id="livelihoodChart"></canvas></div>
                </div>
                <div class="table-container"><table id="livelihoodTable"><thead><tr><th>#</th><th>Livelihood</th><th>Count</th><th>%</th></tr></thead><tbody>${livArray.map((liv, i) => `<tr><td>${i + 1}</td><td>${liv[0]}</td><td class="badge-excellent">${liv[1]}</td><td>${((liv[1] / totalWithLiv) * 100).toFixed(2)}%</td></tr>`).join('')}</tbody></table></div>
            `;

            const top10 = livArray.slice(0, 10);
            if (charts.livelihood) charts.livelihood.destroy();
            charts.livelihood = new Chart(document.getElementById('livelihoodChart').getContext('2d'), {
                type: 'doughnut',
                data: { labels: top10.map(l => l[0].length > 18 ? l[0].substring(0, 18) + '...' : l[0]), datasets: [{ data: top10.map(l => l[1]), backgroundColor: [colors.accent, colors.primary, colors.warning, colors.danger, colors.purple, colors.cyan, colors.pink, colors.success, '#84cc16', '#6366f1'], borderWidth: 0 }] },
                options: { responsive: true, plugins: { legend: { position: 'right', labels: { color: colors.text, font: { size: 10 } } }, datalabels: { color: '#fff', formatter: (v, ctx) => { const pct = ((v / totalWithLiv) * 100).toFixed(1); return pct > 3 ? pct + '%' : ''; }, font: { size: 10 } } } }
            });
        }

        function renderGeoSection(stats) {
            const bankPct = stats.active > 0 ? ((stats.bankLinked / stats.active) * 100).toFixed(1) : 0;
            const avgSHGPerGP = Object.keys(stats.geoData.gramPanchayats).length > 0 ? (stats.active / Object.keys(stats.geoData.gramPanchayats).length).toFixed(1) : 0;
            const avgSHGPerVillage = Object.keys(stats.geoData.villages).length > 0 ? (stats.active / Object.keys(stats.geoData.villages).length).toFixed(1) : 0;
            const topGP = Object.entries(stats.geoData.gramPanchayats).sort((a, b) => b[1] - a[1])[0];
            const topVillage = Object.entries(stats.geoData.villages).sort((a, b) => b[1] - a[1])[0];

            document.getElementById('geoSection').innerHTML = `
                < div class="section-header" >
                    <div class="section-title-group">
                        <div class="section-icon">üó∫Ô∏è</div>
                        <div>
                            <h3 class="section-title">Geographical Analysis</h3>
                            <p class="section-subtitle">Spatial distribution and coverage mapping</p>
                        </div>
                    </div>
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToCSV('geo')">üì• CSV</button>
                        <button class="btn-export" onclick="exportToPDF('geo')">üìÑ PDF</button>
                    </div>
                </div >
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon">üèõÔ∏è</div><div class="stat-value">${Object.keys(stats.geoData.districts).length}</div><div class="stat-label">Districts</div></div>
                    <div class="stat-card"><div class="stat-icon">üèòÔ∏è</div><div class="stat-value">${Object.keys(stats.geoData.gramPanchayats).length}</div><div class="stat-label">Gram Panchayats</div></div>
                    <div class="stat-card"><div class="stat-icon">üè†</div><div class="stat-value">${Object.keys(stats.geoData.villages).length}</div><div class="stat-label">Villages</div></div>
                    <div class="stat-card"><div class="stat-icon">üèòÔ∏è</div><div class="stat-value">${Object.keys(stats.blocks).length}</div><div class="stat-label">Blocks</div></div>
                </div>
                <div class="geo-grid">
                    <div class="geo-map-container"><div id="map"></div></div>
                    <div class="geo-insights">
                        <div class="geo-insight-card"><div class="geo-insight-icon gold">üìç</div><div class="geo-insight-content"><div class="geo-insight-value">${avgSHGPerGP}</div><div class="geo-insight-label">Avg SHGs per GP</div></div></div>
                        <div class="geo-insight-card"><div class="geo-insight-icon blue">üè†</div><div class="geo-insight-content"><div class="geo-insight-value">${avgSHGPerVillage}</div><div class="geo-insight-label">Avg SHGs per Village</div></div></div>
                        <div class="geo-insight-card"><div class="geo-insight-icon green">üèÜ</div><div class="geo-insight-content"><div class="geo-insight-value">${topGP ? topGP[0].substring(0, 18) : '-'}</div><div class="geo-insight-label">Top GP (${topGP ? topGP[1] : 0} SHGs)</div></div></div>
                        <div class="geo-insight-card"><div class="geo-insight-icon purple">üè°</div><div class="geo-insight-content"><div class="geo-insight-value">${topVillage ? topVillage[0].substring(0, 18) : '-'}</div><div class="geo-insight-label">Top Village (${topVillage ? topVillage[1] : 0} SHGs)</div></div></div>
                    </div>
                </div>
                <div class="table-container" style="margin-top: 24px;"><table id="geoTable"><thead><tr><th>#</th><th>Gram Panchayat</th><th>SHGs</th></tr></thead><tbody>${Object.entries(stats.geoData.gramPanchayats).sort((a, b) => b[1] - a[1]).slice(0, 15).map(([gp, count], i) => `<tr><td>${i + 1}</td><td>${gp}</td><td>${count}</td></tr>`).join('')}</tbody></table></div>
            `;

            if (map) map.remove();
            map = L.map('map').setView([11.1271, 78.6569], 8);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

            const blockCoords = {
                'ANDIMADAM': [11.2, 79.0], 'ARIYALUR': [11.14, 79.07], 'JAYANKONDAM': [11.22, 79.34],
                'SENDURAI': [11.28, 79.14], 'THIRUMANUR': [11.12, 79.01], 'T.PALUR': [11.18, 79.12],
                'UDAYARPALAYAM': [11.20, 79.30]
            };

            Object.entries(stats.blocks).forEach(([block, data]) => {
                const coords = blockCoords[block] || [11.1 + Math.random() * 0.3, 78.9 + Math.random() * 0.4];
                const pct = data.total > 0 ? (data.bankLinked / data.total) * 100 : 0;
                const marker = L.circleMarker(coords, {
                    radius: Math.min(Math.max(data.total / 50, 6), 20),
                    fillColor: pct > 90 ? '#059669' : pct > 70 ? '#f59e0b' : '#dc2626',
                    color: '#fff', weight: 2, opacity: 1, fillOpacity: 0.85
                }).addTo(map);
                marker.bindPopup(`< div style = "font-family: sans-serif;" ><b>${block}</b><br>SHGs: ${data.total}<br>Bank: ${pct.toFixed(1)}%<br>Savings: ‚Çπ${formatNumber(data.savings)}</div>`);
            });
        }

        function renderInsightsSection(stats) {
            const bankPct = stats.active > 0 ? ((stats.bankLinked / stats.active) * 100) : 0;
            const avgSavings = stats.active > 0 ? Math.round(stats.totalSavings / stats.active) : 0;
            const complianceRate = stats.active > 0 ? (((stats.active - stats.memberCompliance.total) / stats.active) * 100).toFixed(1) : 100;

            const topBlocks = Object.entries(stats.blocks).sort((a, b) => b[1].total - a[1].total).slice(0, 3);
            const topSavingsBlocks = Object.entries(stats.blocks).sort((a, b) => b[1].savings - a[1].savings).slice(0, 3);
            const topLiv = Object.entries(stats.livelihoods).sort((a, b) => b[1] - a[1]).slice(0, 3);
            const weeklyMeetings = stats.meetingFreq['Weekly'] || 0;
            const weeklyPct = stats.active > 0 ? ((weeklyMeetings / stats.active) * 100).toFixed(1) : 0;

            const insights = [
                { type: 'info', text: `<strong>üèòÔ∏è Top Blocks:</strong> ${topBlocks.map(b => `${b[0]} (${b[1].total})`).join(', ')}` },
                { type: '', text: `<strong>üí∞ Savings Leaders:</strong> ${topSavingsBlocks.map(b => `${b[0]} (‚Çπ${formatNumber(b[1].savings)})`).join(', ')}` },
                { type: '', text: `<strong>üìÖ FY 25-26:</strong> ${stats.fyFormed} SHGs formed (${stats.fyWomanRegular} Woman Regular, ${stats.fySpecial} Special)` },
                { type: bankPct >= 90 ? 'success' : bankPct >= 70 ? 'warning' : 'danger', text: bankPct >= 90 ? `<strong>‚úÖ Excellent Bank Linkage:</strong> ${bankPct.toFixed(1)}%` : `<strong>üè¶ Bank Linkage:</strong> ${bankPct.toFixed(1)}%. ${stats.active - stats.bankLinked} SHGs need accounts.` },
                { type: stats.memberCompliance.total > 0 ? 'danger' : 'success', text: stats.memberCompliance.total > 0 ? `<strong>‚ö†Ô∏è Compliance:</strong> ${stats.memberCompliance.total} SHGs have low members (${complianceRate}% compliant)` : `<strong>‚úÖ Full Compliance:</strong> All SHGs meet requirements` },
                { type: 'info', text: `<strong>üí∞ Savings:</strong> Total ‚Çπ${formatNumber(stats.totalSavings)} | Avg ‚Çπ${formatNumber(avgSavings)} per SHG` },
                { type: '', text: `<strong>üìÖ Meetings:</strong> ${weeklyPct}% weekly (${weeklyMeetings} groups)` },
                { type: '', text: `<strong>üåæ Livelihoods:</strong> ${topLiv.map(l => `${l[0]} (${l[1]})`).join(', ') || 'No data'}` },
                { type: 'info', text: `<strong>üó∫Ô∏è Coverage:</strong> ${Object.keys(stats.blocks).length} blocks, ${Object.keys(stats.geoData.gramPanchayats).length} GPs, ${Object.keys(stats.geoData.villages).length} villages` }
            ];

            document.getElementById('insightsSection').innerHTML = `
                <div class="section-header">
                    <div class="section-title-group">
                        <div class="section-icon">ü§ñ</div>
                        <div>
                            <h3 class="section-title">AI-Powered Insights</h3>
                            <p class="section-subtitle">Intelligent recommendations and analysis</p>
                        </div>
                    </div>
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportInsightsToPDF()">üìÑ Export Report</button>
                    </div>
                </div>
                <div class="insights-grid">${insights.map(i => `<div class="insight-card ${i.type}"><p>${i.text}</p></div>`).join('')}</div>
            `;
        }

        function renderAllSections(stats) {
            renderOverview(stats);
            renderFYSection(stats);
            renderFinancialSection(stats);
            renderBlockSection(stats);
            renderBankSection(stats);
            renderMemberSection(stats);
            renderLivelihoodSection(stats);
            renderGeoSection(stats);
            renderInsightsSection(stats);
        }

        // ============ FILTER FUNCTIONS ============
        function filterTable(tableId, searchText) {
            const table = document.getElementById(tableId);
            if (!table) return;
            table.querySelectorAll('tbody tr').forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(searchText.toLowerCase()) ? '' : 'none';
            });
        }

        function filterTableByStatus(tableId, status) {
            const table = document.getElementById(tableId);
            if (!table) return;
            table.querySelectorAll('tbody tr').forEach(row => {
                row.style.display = !status || row.dataset.status === status ? '' : 'none';
            });
        }

        // ============ EXPORT FUNCTIONS - FIXED ============

        // Helper function to download file - with delayed cleanup
        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);

            // Use setTimeout to ensure the click event completes
            setTimeout(() => {
                link.click();

                // Delay cleanup to allow download to start
                setTimeout(() => {
                    if (link.parentNode) {
                        document.body.removeChild(link);
                    }
                    URL.revokeObjectURL(url);
                }, 250);
            }, 0);
        }

        // Get table ID mapping
        function getTableIdForSection(section) {
            const tableMap = {
                'overview': null,
                'fyFormation': 'fyFormationTable',
                'financial': 'financialTable',
                'block': 'blockTable',
                'bank': 'bankTable',
                'member': 'memberTable',
                'livelihood': 'livelihoodTable',
                'geo': 'geoTable',
                'insights': null
            };
            return tableMap[section] || null;
        }

        function exportToCSV(section) {
            console.log('Exporting CSV for section:', section);

            if (!analyzedStats) {
                showToast('No data available. Please upload a file first.', true);
                return;
            }

            let csvContent = '';
            const dateStr = new Date().toISOString().split('T')[0];

            // Handle overview section specially (no table)
            if (section === 'overview') {
                const data = [
                    ['Metric', 'Value'],
                    ['Total SHGs', analyzedStats.total],
                    ['Active SHGs', analyzedStats.active],
                    ['Inactive SHGs', analyzedStats.inactive],
                    ['Bank Linked', analyzedStats.bankLinked],
                    ['Bank Linkage %', ((analyzedStats.bankLinked / analyzedStats.active) * 100).toFixed(1) + '%'],
                    ['Total Members', analyzedStats.totalMembers],
                    ['Total Savings', analyzedStats.totalSavings],
                    ['FY 2025-26 Formed', analyzedStats.fyFormed],
                    ['Blocks Covered', Object.keys(analyzedStats.blocks).length]
                ];
                csvContent = data.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                downloadFile(blob, `SHG_Overview_${dateStr}.csv`);
                showToast('Overview exported to CSV successfully!');
                return;
            }

            // Handle insights section specially (no table)
            if (section === 'insights') {
                const bankPct = analyzedStats.active > 0 ? ((analyzedStats.bankLinked / analyzedStats.active) * 100).toFixed(1) : 0;
                const avgSavings = analyzedStats.active > 0 ? Math.round(analyzedStats.totalSavings / analyzedStats.active) : 0;

                const data = [
                    ['Insight Type', 'Details'],
                    ['Total Active SHGs', analyzedStats.active],
                    ['Bank Linkage', bankPct + '%'],
                    ['Total Savings', 'Rs.' + formatNumber(analyzedStats.totalSavings)],
                    ['Avg Savings per SHG', 'Rs.' + formatNumber(avgSavings)],
                    ['FY 25-26 Formed', analyzedStats.fyFormed],
                    ['Non-Compliant SHGs', analyzedStats.memberCompliance.total],
                    ['Blocks Covered', Object.keys(analyzedStats.blocks).length],
                    ['GPs Covered', Object.keys(analyzedStats.geoData.gramPanchayats).length],
                    ['Villages Covered', Object.keys(analyzedStats.geoData.villages).length]
                ];
                csvContent = data.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                downloadFile(blob, `SHG_Insights_${dateStr}.csv`);
                showToast('Insights exported to CSV successfully!');
                return;
            }

            // Find table by ID
            const tableId = getTableIdForSection(section);
            const table = tableId ? document.getElementById(tableId) : null;

            if (!table) {
                showToast('No table data found for this section.', true);
                return;
            }

            // Extract table data
            const rows = [];
            table.querySelectorAll('tr').forEach(row => {
                const cols = row.querySelectorAll('td, th');
                if (cols.length > 0) {
                    const rowData = Array.from(cols).map(col => `"${col.textContent.trim().replace(/"/g, '""')}"`);
                    rows.push(rowData.join(','));
                }
            });

            if (rows.length === 0) {
                showToast('No data to export.', true);
                return;
            }

            csvContent = rows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            downloadFile(blob, `SHG_${section}_${dateStr}.csv`);
            showToast(`${section} data exported to CSV successfully!`);
        }

        function exportToPDF(section) {
            console.log('Exporting PDF for section:', section);

            if (!analyzedStats) {
                showToast('No data available. Please upload a file first.', true);
                return;
            }

            // Check if jsPDF is loaded
            if (typeof window.jspdf === 'undefined') {
                showToast('PDF library not loaded. Please refresh the page.', true);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const dateStr = new Date().toISOString().split('T')[0];

            // Header
            doc.setFontSize(20);
            doc.setTextColor(26, 54, 93);
            doc.text('SHG Analytics Pro', 14, 20);

            doc.setFontSize(14);
            doc.setTextColor(212, 168, 83);
            const sectionTitle = section.charAt(0).toUpperCase() + section.slice(1).replace(/([A-Z])/g, ' $1');
            doc.text(`${sectionTitle} Report`, 14, 30);

            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 38);

            doc.setDrawColor(26, 54, 93);
            doc.setLineWidth(0.5);
            doc.line(14, 42, 196, 42);

            // Handle overview section
            if (section === 'overview') {
                let yPos = 52;
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);

                const metrics = [
                    ['Total SHGs', analyzedStats.total.toLocaleString()],
                    ['Active SHGs', analyzedStats.active.toLocaleString()],
                    ['Inactive SHGs', analyzedStats.inactive.toLocaleString()],
                    ['Bank Linked', analyzedStats.bankLinked.toLocaleString()],
                    ['Bank Linkage %', ((analyzedStats.bankLinked / analyzedStats.active) * 100).toFixed(1) + '%'],
                    ['Total Members', analyzedStats.totalMembers.toLocaleString()],
                    ['Total Savings', 'Rs. ' + formatNumber(analyzedStats.totalSavings)],
                    ['FY 2025-26 Formed', analyzedStats.fyFormed.toLocaleString()],
                    ['Blocks Covered', Object.keys(analyzedStats.blocks).length.toString()]
                ];

                metrics.forEach(([label, value]) => {
                    doc.setFont(undefined, 'bold');
                    doc.text(label + ':', 14, yPos);
                    doc.setFont(undefined, 'normal');
                    doc.text(value, 80, yPos);
                    yPos += 10;
                });

                doc.save(`SHG_Overview_${dateStr}.pdf`);
                showToast('Overview exported to PDF successfully!');
                return;
            }

            // Handle insights section
            if (section === 'insights') {
                let yPos = 52;
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);

                const bankPct = analyzedStats.active > 0 ? ((analyzedStats.bankLinked / analyzedStats.active) * 100).toFixed(1) : 0;
                const avgSavings = analyzedStats.active > 0 ? Math.round(analyzedStats.totalSavings / analyzedStats.active) : 0;
                const complianceRate = analyzedStats.active > 0 ? (((analyzedStats.active - analyzedStats.memberCompliance.total) / analyzedStats.active) * 100).toFixed(1) : 100;
                const topBlocks = Object.entries(analyzedStats.blocks).sort((a, b) => b[1].total - a[1].total).slice(0, 3);

                const insights = [
                    `Top Blocks: ${topBlocks.map(b => b[0] + ' (' + b[1].total + ')').join(', ')}`,
                    `FY 2025-26 Formation: ${analyzedStats.fyFormed} SHGs`,
                    `Bank Linkage: ${bankPct}% (${analyzedStats.bankLinked} of ${analyzedStats.active} SHGs)`,
                    `Member Compliance: ${complianceRate}% rate`,
                    `Total Savings: Rs. ${formatNumber(analyzedStats.totalSavings)}`,
                    `Avg Savings per SHG: Rs. ${formatNumber(avgSavings)}`,
                    `Coverage: ${Object.keys(analyzedStats.blocks).length} blocks, ${Object.keys(analyzedStats.geoData.gramPanchayats).length} GPs`
                ];

                insights.forEach(insight => {
                    const lines = doc.splitTextToSize(insight, 180);
                    lines.forEach(line => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.text(line, 14, yPos);
                        yPos += 8;
                    });
                    yPos += 4;
                });

                doc.save(`SHG_Insights_${dateStr}.pdf`);
                showToast('Insights exported to PDF successfully!');
                return;
            }

            // Find table for other sections
            const tableId = getTableIdForSection(section);
            const table = tableId ? document.getElementById(tableId) : null;

            if (table && typeof doc.autoTable === 'function') {
                const headers = [];
                const body = [];

                const headerRow = table.querySelector('thead tr');
                if (headerRow) {
                    headerRow.querySelectorAll('th').forEach(th => headers.push(th.textContent.trim()));
                }

                table.querySelectorAll('tbody tr').forEach(row => {
                    const rowData = [];
                    row.querySelectorAll('td').forEach(td => rowData.push(td.textContent.trim()));
                    if (rowData.length > 0) body.push(rowData);
                });

                if (headers.length > 0 && body.length > 0) {
                    doc.autoTable({
                        head: [headers],
                        body: body,
                        startY: 50,
                        styles: { fontSize: 8, cellPadding: 3 },
                        headStyles: { fillColor: [26, 54, 93], textColor: [255, 255, 255], fontStyle: 'bold' },
                        alternateRowStyles: { fillColor: [245, 245, 245] },
                        margin: { top: 50 }
                    });
                }
            } else {
                doc.setFontSize(12);
                doc.text('No table data available for this section.', 14, 55);
            }

            doc.save(`SHG_${section}_${dateStr}.pdf`);
            showToast(`${section} data exported to PDF successfully!`);
        }

        function exportInsightsToPDF() {
            exportToPDF('insights');
        }

        // ============ POPUP FUNCTIONS ============
        function showSuccess() {
            document.getElementById('overlay').style.display = 'block';
            const popup = document.getElementById('successPopup');
            popup.style.display = 'block';
            setTimeout(() => popup.classList.add('show'), 10);
        }

        function closeSuccessPopup() {
            document.getElementById('successPopup').classList.remove('show');
            setTimeout(() => { document.getElementById('successPopup').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; }, 400);
        }

        // ============ MAIN PROCESS ============
        function processExcel() {
            const file = document.getElementById('excelFile').files[0];
            if (!file) return alert('Please select an Excel file');

            const btn = document.getElementById('uploadBtn');
            const spinner = document.getElementById('loadingSpinner');
            const status = document.getElementById('statusText');

            btn.disabled = true; btn.textContent = 'Analyzing...'; spinner.style.display = 'block'; status.textContent = 'Processing your file...';

            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(ws, { defval: '', range: 2 });

                    if (!rows.length) throw new Error('No data found');
                    originalData = rows;

                    setTimeout(() => {
                        Object.values(charts).forEach(chart => { if (chart && chart.destroy) chart.destroy(); });
                        charts = {};

                        analyzedStats = analyzeData(rows);
                        renderAllSections(analyzedStats);

                        document.getElementById('navTabs').classList.add('visible');
                        document.getElementById('uploadSection').style.display = 'none';
                        document.getElementById('overviewSection').classList.remove('hidden-section');

                        btn.disabled = false; btn.textContent = 'üîç Analyze Data'; spinner.style.display = 'none';
                        status.textContent = `‚úÖ Processed ${analyzedStats.active.toLocaleString()} active SHGs`;

                        showSuccess();
                    }, 500);
                } catch (error) {
                    alert('Error: ' + error.message);
                    btn.disabled = false; btn.textContent = 'üîç Analyze Data'; spinner.style.display = 'none';
                    status.textContent = '‚ùå Error processing file';
                }
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>

</html>